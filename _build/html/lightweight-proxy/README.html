

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Light Weight Proxy (LWP) &mdash; F5 Container Integration 0.1_a documentation</title>
  

  
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  

  
    <link rel="top" title="F5 Container Integration 0.1_a documentation" href="../index.html"/> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">

  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> F5 Container Integration
          

          
          </a>

          
            
            
              <div class="version">
                0.1_a
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../f5-marathon-lb/index.html">f5-marathon-lb</a></li>
<li class="toctree-l1"><a class="reference internal" href="index.html">Light Weight Proxy (LWP)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../lwp-controller/index.html">lwp-controller</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../index.html">F5 Container Integration</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../index.html">Docs</a> &raquo;</li>
      
    <li>Light Weight Proxy (LWP)</li>
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/lightweight-proxy/README.txt" rel="nofollow"> View page source</a>
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="light-weight-proxy-lwp">
<span id="light-weight-proxy-lwp"></span><h1>Light Weight Proxy (LWP)<a class="headerlink" href="#light-weight-proxy-lwp" title="Permalink to this headline">¶</a></h1>
<p>The LWP is designed to collect and report statistics (HTTP and TCP) about
services for which it acts as a proxy. In aggregate, these statistics should
provide visualization into a distributed application&#8217;s environment and health.
The LWP also provides basic load balancing services for client requests and
connections across an applications&#8217;s server pool.</p>
<div class="section" id="project-setup">
<span id="project-setup"></span><h2>Project Setup<a class="headerlink" href="#project-setup" title="Permalink to this headline">¶</a></h2>
<p>Gitlab LWP project:
git&#64;bldr-git.int.lineratesystems.com:velcro/lightweight-proxy.git</p>
<div class="section" id="vagrant-environment">
<span id="vagrant-environment"></span><h3>Vagrant environment<a class="headerlink" href="#vagrant-environment" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ git clone [gitlab LWP project]
$ cd lightweight-proxy
$ vagrant up
$ vagrant ssh
</pre></div>
</div>
</div>
<div class="section" id="manual-environment-setup">
<span id="manual-environment-setup"></span><h3>Manual environment setup<a class="headerlink" href="#manual-environment-setup" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ curl -sL https://deb.nodesource.com/setup_6.x | sudo -E bash -
# CLANG_VERSION must be =3.7 currently
$ sudo apt-get update
$ sudo apt-get install build-essential make git nodejs \
    clang-format-${CLANG_VERSION}
$ sudo ln -sf /usr/bin/clang-format-${CLANG_VERSION} /usr/bin/clang-format
$ git clone [gitlab LWP project]
$ cd lightweight-proxy
$ npm install
$ make test
</pre></div>
</div>
</div>
</div>
<div class="section" id="features">
<span id="features"></span><h2>Features<a class="headerlink" href="#features" title="Permalink to this headline">¶</a></h2>
<div class="section" id="header-manipulation-module-http-only">
<span id="header-manipulation-module-http-only"></span><h3>Header Manipulation Module (HTTP only)<a class="headerlink" href="#header-manipulation-module-http-only" title="Permalink to this headline">¶</a></h3>
<p>This module provides functionality to manipulate HTTP headers (add, remove or
modify) using the underlying Node.js header manipulation API (setHeader,
getHeader, removeHeader) on the http.ClientRequest and http.serverResponse
objects.  LWP will have the same semantics for adding headers as the Node.js
setHeader method, namely:</p>
<ul class="simple">
<li>Sets a single header value for implicit headers</li>
<li>If header already exists, its value will be replaced</li>
<li>Use an array of values if you need to send header with multiple values</li>
</ul>
</div>
<div class="section" id="load-balancing-module">
<span id="load-balancing-module"></span><h3>Load Balancing Module<a class="headerlink" href="#load-balancing-module" title="Permalink to this headline">¶</a></h3>
<p>This module queries the marathon-dns module for the current list of servers and
implements load balancing algorithm to choose a back-end server.</p>
<ul class="simple">
<li>Round-robin load balancing</li>
<li>Collection of load balancing related statistics</li>
</ul>
</div>
<div class="section" id="connection-module">
<span id="connection-module"></span><h3>Connection Module<a class="headerlink" href="#connection-module" title="Permalink to this headline">¶</a></h3>
<p>This module is responsible for managing server connections which involves the
following:</p>
<ul class="simple">
<li>Maintain a mapping of client to server connection</li>
<li>Given a client connection, check if corresponding server connection exists.
Reuse connection if it already exists. Else create a new one.</li>
<li>Implement similar lookup in reverse direction (i.e., lookup client connection
given server connection).</li>
<li>Manage lifetime of server connection. Server connection is closed when:<ul>
<li>client connection closes</li>
<li>inactivity timeout fires</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="forwarding-module">
<span id="forwarding-module"></span><h3>Forwarding Module<a class="headerlink" href="#forwarding-module" title="Permalink to this headline">¶</a></h3>
<p>This module is responsible for forwarding data back and forth between client and
server connections. The initial implementation will support the following modes:</p>
<ul class="simple">
<li>HTTP Forwarding<ul>
<li>Provide HTTP proxy functionality between client and server.</li>
<li>Collect HTTP statistics:<ul>
<li>across transactions: request / response counts, status code counts,
method counts, error counts, etc.</li>
<li>per transaction: client and server address, url, method, status code,
server RTT, latency at various stages, etc.</li>
</ul>
</li>
</ul>
</li>
<li>TCP Forwarding<ul>
<li>Provide TCP proxy functionality between client and application.</li>
<li>Collect TCP statistics:<ul>
<li>across connections: total connections, current connections,
total closed, error counts, etc.</li>
<li>per connection: client and server address, bytes read, bytes written,
server RTT, latency at various stages, etc.</li>
</ul>
</li>
<li>Other TCP configure options: max connection limit</li>
</ul>
</li>
</ul>
</div>
<div class="section" id="configuration">
<span id="configuration"></span><h3>Configuration<a class="headerlink" href="#configuration" title="Permalink to this headline">¶</a></h3>
<p>Configuration is expected to be valid JSON containing a global section, a stats
section, and a virtual servers list.</p>
<ul class="simple">
<li>Global section: configuration from the controller to control the process.</li>
<li>Stats section: configuration specific to statistics gathering and reporting.</li>
<li>Virtual servers section: list of virtual server objects representing service
endpoints.</li>
</ul>
<p>Configuration can be passed in one of two methods. The LWP can be run with a
&#8211;config-file option which accepts a file name containing the JSON config. The
LWP will also look for the LWP_CONFIG environment variable.</p>
<p>An LWP may be invoked simply via the command line thusly:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ lwp_proxy --config-file=/home/proxy/config.json
</pre></div>
</div>
<p>or</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ LWP_CONFIG=&#39;{ &quot;virtual-servers&quot;: { ... } }&#39; lwp_proxy
</pre></div>
</div>
<p>The latter method eases LWP startup in a containerized environment, starting a
LWP via docker would be accomplished similarly to this:</p>
<div class="highlight-default"><div class="highlight"><pre><span></span>$ docker run -e LWP_CONFIG=&#39;{ &quot;virtual-servers&quot;: { ... } }&#39; -p 8080:8080 -d
f5/lwp-proxy
</pre></div>
</div>
<div class="section" id="configuration-parameters">
<span id="configuration-parameters"></span><h4>Configuration Parameters<a class="headerlink" href="#configuration-parameters" title="Permalink to this headline">¶</a></h4>
<p>Global section is defined as such:</p>
<p>| Field               | Type           | Required | Default       | Description | Allowed Values |
| &#8212;&#8211;               | &#8212;&#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8211; | &#8212;&#8212;-       | &#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8212;&#8212;&#8211; |
| marathon-uri        | string         | Yes      | <none>        | URL of the marathon service.||
| console-log-level   | string         | No       | info          | Logging level | &#8216;emerg&#8217;, &#8216;alert&#8217;, &#8216;crit&#8217;, &#8216;error&#8217;, &#8216;warning&#8217;, &#8216;notice&#8217;, &#8216;info&#8217;, &#8216;debug&#8217; |</p>
<p>Stats section is defined as such:</p>
<p>| Field               | Type           | Required | Default       | Description | Allowed Values |
| &#8212;&#8211;               | &#8212;&#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8211; | &#8212;&#8212;-       | &#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8212;&#8212;&#8211; |
| url                 | string         | Yes      | <none>        | URL of the stats service.||
| token               | string         | Yes      | <none>        | Authentication token for the stats server.||
| flushInterval       | number         | No       | 10000         | Frequency in milliseconds of flushing stats to server.||
| backend             | string         | Yes      | <none>        | Type of backend stats service.| &#8216;leo&#8217;, &#8216;splunk&#8217;|</p>
<p>A virtual server configuration object is defined as such:</p>
<p>| Field               | Type           | Required | Default       | Description | Allowed Values |
| &#8212;&#8211;               | &#8212;&#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8211; | &#8212;&#8212;-       | &#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8212;&#8212;&#8211; |
| destination         | number         | Yes      | <none>        | Service port this virtual server accepts cxns. ||
| service-name        | string         | Yes      | <none>        | Application tag this virtual server proxies for, services are discovered dynamically. ||
| ip-protocol         | string         | No       | &#8216;http&#8217;        | Service type of this virtual server. | &#8216;http&#8217;, &#8216;tcp&#8217;|
| load-balancing-mode | string         | No       | &#8216;round-robin&#8217; | Load balancing algorithm for this virtual server.| &#8216;round-robin&#8217;|
| keep-alive-msecs    | number         | No       | 1000          | Time (in milliseconds) between TCP keep-alive packets on socket to back-end server. ||
| flags               | JSON Object    | No       | <none>        | Flags specific to virtual server||</p>
<p>Flags section in virtual server is defined as such:</p>
<p>| Field               | Type           | Required | Default       | Description | Allowed Values |
| &#8212;&#8211;               | &#8212;&#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8211; | &#8212;&#8212;-       | &#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8212;&#8212;&#8211; |
| x-forwarded-for     | boolean        | No       | false         | Flag to set x-forwarded-for header in request to backend server.||
| x-served-by         | boolean        | No       | false         | Flag to set x-served-by header in response to client.||</p>
</div>
<div class="section" id="example-config">
<span id="example-config"></span><h4>Example Config<a class="headerlink" href="#example-config" title="Permalink to this headline">¶</a></h4>
<p>An example configuration containing two virtual server sections:</p>
<div class="highlight-javascript"><div class="highlight"><pre><span></span><span class="p">{</span>
  <span class="s2">&quot;global&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;marathon-uri&quot;</span><span class="o">:</span> <span class="s2">&quot;http://api.mesos.example.com&quot;</span><span class="p">,</span>
    <span class="s2">&quot;console-log-level&quot;</span><span class="o">:</span> <span class="s2">&quot;debug&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;stats&quot;</span><span class="o">:</span> <span class="p">{</span>
    <span class="s2">&quot;url&quot;</span><span class="o">:</span> <span class="s2">&quot;http://localhost:8088&quot;</span><span class="p">,</span>
    <span class="s2">&quot;token&quot;</span><span class="o">:</span> <span class="s2">&quot;this-is-the-token&quot;</span><span class="p">,</span>
    <span class="s2">&quot;flushInterval&quot;</span><span class="o">:</span> <span class="mi">10000</span><span class="p">,</span>
    <span class="s2">&quot;backend&quot;</span><span class="o">:</span> <span class="s2">&quot;splunk&quot;</span>
  <span class="p">},</span>
  <span class="s2">&quot;virtual-servers&quot;</span><span class="o">:</span> <span class="p">[</span>
    <span class="p">{</span>
      <span class="s2">&quot;destination&quot;</span><span class="o">:</span> <span class="mi">8080</span><span class="p">,</span>
      <span class="s2">&quot;service-name&quot;</span><span class="o">:</span> <span class="s2">&quot;web-server&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ip-protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;http&quot;</span><span class="p">,</span>
      <span class="s2">&quot;load-balancing-mode&quot;</span><span class="o">:</span> <span class="s2">&quot;round-robin&quot;</span><span class="p">,</span>
      <span class="s2">&quot;flags&quot;</span> <span class="o">:</span> <span class="p">{</span>
        <span class="s2">&quot;x-forwarded-for&quot;</span><span class="o">:</span> <span class="kc">false</span><span class="p">,</span>
        <span class="s2">&quot;x-served-by&quot;</span><span class="o">:</span> <span class="kc">true</span>
      <span class="p">}</span>
    <span class="p">},</span>
    <span class="p">{</span>
      <span class="s2">&quot;destination&quot;</span><span class="o">:</span> <span class="mi">9090</span><span class="p">,</span>
      <span class="s2">&quot;service-name&quot;</span><span class="o">:</span> <span class="s2">&quot;identity&quot;</span><span class="p">,</span>
      <span class="s2">&quot;ip-protocol&quot;</span><span class="o">:</span> <span class="s2">&quot;http&quot;</span><span class="p">,</span>
      <span class="s2">&quot;load-balancing-mode&quot;</span><span class="o">:</span> <span class="s2">&quot;round-robin&quot;</span><span class="p">,</span>
      <span class="s2">&quot;keep-alive-msecs&quot;</span><span class="o">:</span> <span class="mi">2000</span>
    <span class="p">}</span>
  <span class="p">]</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="statistics">
<span id="statistics"></span><h3>Statistics<a class="headerlink" href="#statistics" title="Permalink to this headline">¶</a></h3>
<p>The LWP will provide statistics in Splunk format to a configured Splunk server
or an F5 statistics gatherer and visualizer.</p>
<div class="section" id="global-stats">
<span id="global-stats"></span><h4>Global Stats<a class="headerlink" href="#global-stats" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>splunk source: lwp.transaction</li>
<li>splunk sourcetype: f5:lwp.stats:json</li>
<li>Frequency: periodic (controlled by LWP_CONFIG environment variable)</li>
</ul>
<p>| Name                 | Description |
| &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8211; | &#8212;&#8212;&#8212;&#8211; |
| tot_requests         | Number of HTTP requests received from the clients|
| clientside_tot_conns | Number of TCP connections received from the clients |
| clientside_cur_conns | Current number of active TCP connections to the clients |
| clientside_max_conns | Maximum number of active TCP connections to the clients since the start of LWP |
| clientside_bytes_in  | Number of bytes read from the clients |
| clientside_bytes_out | Number of bytes written to the clients |
| serverside_tot_conns | Number of TCP connections opened to the servers |
| serverside_cur_conns | Current number of active TCP connections to the servers |
| serverside_max_conns | Maximum number of active TCP connections to the servers since the start of LWP |
| server_latency       | Average time (in milliseconds) to connection to a server |
| max_server_latency   | Maximum time (in milliseconds) to connection to a server |
| failed_tcp_conns     | Number of TCP connections that have failed |</p>
</div>
<div class="section" id="tcp-transaction-stats">
<span id="tcp-transaction-stats"></span><h4>TCP Transaction Stats<a class="headerlink" href="#tcp-transaction-stats" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>splunk source: lwp.transaction</li>
<li>splunk sourcetype: f5:lwp.stats:json</li>
<li>Frequency: per connection</li>
</ul>
<p>| Name             | Description  |
| &#8212;&#8212;&#8212;&#8212;&#8212;- | &#8212;&#8212;&#8212;&#8212; |
| client_ip        | IP Address of the connection |
| client_port      | TCP Port of the connection |
| pool_member_name | ID of the particular server pool member (embeds the server name) |
| pool_member_ip   | IP address for the particular server pool member |
| pool_member_port | TCP port of the particular server pool member |</p>
</div>
<div class="section" id="http-transaction-stats">
<span id="http-transaction-stats"></span><h4>HTTP Transaction Stats<a class="headerlink" href="#http-transaction-stats" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>splunk source: lwp.transaction</li>
<li>splunk sourcetype: f5:lwp.stats:json</li>
<li>Frequency: per request</li>
</ul>
<p>| Name                  | Description  |
| &#8212;&#8212;&#8212;&#8212;&#8212;&#8212;&#8212; | &#8212;&#8212;&#8212;&#8212; |
| client_ip             | IP address of the connection associated with this request |
| client_port           | TCP port of the connect associated with this request |
| client_user           | HTTP basic authentication user |
| ttfb                  | time-to-first-byte: Time (in milliseconds) between when the request was received and starting to write out the response headers |
| ttlb                  | time-to-first-byte: Time (in milliseconds) between when the request was received and writing out the last byte of the response body |
| response_status_code  | HTTP response code (e.g. 200) |
| http_version          | HTTP protocol version being used by the client (e.g. &#8220;1.1&#8221;) |
| method_name           | HTTP method for this request (e.g. &#8220;POST&#8221;) |
| request_date          | Time (in milliseconds) when this request was received |
| pool_member_name      | ID of the particular server pool member (embeds the server name) |
| pool_member_ip        | IP address for the particular server pool member |
| pool_member_port      | TCP port of the particular server pool member |
| url                   | URL for the HTTP request |
| user_agent            | HTTP user agent of the client |
| referrer              | HTTP referer which indicates the originating URI |
| request_headers_size  | Size (in bytes) of the request headers |
| request_body_size     | Size (in bytes) of the request body |
| response_headers_size | Size (in bytes) of the response headers |
| response_body_size    | Size (in bytes) of the response body |</p>
</div>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2016, F5 Networks.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/snide/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'0.1_a',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
      });
  </script>
   

</body>
</html>